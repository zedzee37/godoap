using System.Collections.Generic;
using System.Linq;

#nullable enable
public class Planner<T>
{
	private List<Action<T>> actions;
	private List<Goal<T>> goals;
	private Goal<T>? currentGoal;

	private Planner(List<Action<T>> actions, List<Goal<T>> goals) 
	{
		this.actions = actions;
		this.goals = goals;
		currentGoal = null;
	}

	private Goal<T>? GetHighestPriorityGoal(WorldState state, T self)
	{
		Goal<T>? goal = currentGoal;
		float currentPriority = currentGoal != null ? currentGoal.GetPriority(state, self) : 0.0F;

		this.goals.ForEach(newGoal =>
				{
					float priority = newGoal.GetPriority(state, self);
					if (priority > currentPriority)
					{
						goal = newGoal;
						currentPriority = priority;
					}
				}
		);

		return goal;
	}

	private ActionNode<T> PlanActions(WorldState state, T self)
	{
		ActionNode<T> head = new ActionNode<T>(state);
		return head;
	}

	private void BuildActionTree(ActionNode<T> parent, T self)
	{
		List<Action<T>> availableActions = GetActionsForState(parent.state);	
		availableActions.ForEach(action => {
				WorldState outcome = action.DesiredOutcome;
				
				if (currentGoal == null)
				{
					return;
				}

				ActionNode<T> node = new ActionNode<T>(action, outcome);

				parent.AddChild(node);
				if (!currentGoal.GoalComplete(outcome))
				{
					BuildActionTree(node, self);
				}
		});
	}

	private List<Action<T>> GetActionsForState(WorldState state)
	{
		return (from action in actions
				where action.IsAvailable(state)
				select action).ToList();
	}

	public class Builder 
	{
		private List<Action<T>> actions;
		private List<Goal<T>> goals;

		public Builder() 
		{
			actions = new List<Action<T>>();
			goals = new List<Goal<T>>();
		}

		public Builder Action(Action<T> action)
		{
			this.actions.Add(action);
			return this;
		}

		public Builder Goal(Goal<T> goal)
		{
			this.goals.Add(goal);
			return this;
		}

		public Planner<T> Build()
		{
			return new Planner<T>(this.actions, this.goals);
		}
	}
}
